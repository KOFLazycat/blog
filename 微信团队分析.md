=============================================================
1. 微信团队
=============================================================



-------------------------------------------------------------
1.1. 产品
-------------------------------------------------------------

1.1.1. 此时距微信项目构想的提出还不到一年半的时间。2010年10月，一款名为Kik的App因上线
15天就收获了100万用户而引起业内关注。Kik是一款基于手机通讯录实现免费短信聊天功能的应用软件。腾讯广州研发部与张小龙其人：
腾讯广州研发部总经理张小龙Allen注意到了Kik的快速崛起。一天晚上，他在看Kik类的软件时，产生了一个想法：移动互联网将来会有一个新的IM，而这种新的IM很可能会对QQ造成很大威胁。他想了一两个小时后，向腾讯CEO马化腾Pony写了封邮件，建议腾讯做这一块的东西。Pony很快回复了邮件表示对这
个建议的认同。Allen随后向Pony建议广州研发部来承担这个项目的开发。“反正是研究性的，没有人知道未来会怎么样，”Allen回忆说，“整个过程起点就是一两个小时，突然搭错了一个神经，写了这个邮件，就开始了。”


-------------------------------------------------------------
1.2. 技术架构
-------------------------------------------------------------

1.2.1. 协议

  1.2.1.1. 手机终端跟后台服务器之间的交互协议，这个协议的设计是整个系统的骨架，在这一点做好
设计可以使得系统的复杂度大大降低

    1.2.1.1.1. 在协议设计上，移动互联网和常规互联网有很大的区别。首先有CMWAP和CMNET的不同，在中国现在有相当多的手机用户使用WMWAP连接，还有就是在线和离线的概念，当QQ下线的时候叫离线，当你登录的时候叫在线。但是在移动互联网这两个概念比较模糊。从微信的设计中，不管在线还是离线系统表现都应该是一致的。还有一个是连接不稳定的问题，由于手机信号强弱的变化，当时信号很好，5秒钟走到信号不好的地区，连接就必须断掉。这个中间带来不稳定的因素为协议设计带来较大困难。此外就是资费敏感的问题，因为移动互联网是按照流量计费的，这个计费会使得在协议设计中如何最小化传输的问题。最后就是高延迟的问题。

    1.2.1.1.2. 对此，业界标准的解决方案：Messaging And Presence Protocol：
1)XMPP;
2)SIP/SIMPLE。
它的优点是简单，大量开源实现。而缺点同样明显：1)流量大：状态初始化；2)消息不可靠。

    1.2.1.1.3. 微信在系统中做了特殊设计，叫SYNC协议，是参考Activesyec来实现的。特点首先是基于状态同步的协议，假定说收发消息本身是状态同步的过程，假定终端和服务器状态已经被迟了，在服务器端收到最新的消息，当客户端、终端向服务器对接的时候，收取消息的过程实际上可以简单的归纳为状态同步的过程，收消息以及收取你好友状态更新都是相同的。在这样的模式之下，我们会也许会把交互的模式统
一化，只需要推送一个消息到达的通知就可以了，终端收到这个通知就来做消息的同步。在这样的简化模式之下，安卓和塞班都可以得到统一。这样的系统本身的实现是更为复杂的，但是获得很多额外的好处。

    1.2.1.1.4. 让剩下系统实现的部分更加简单，简化了交互模式，状态同步可以通过状态同步的差值获得最小的数据变更，通过增量的传输得到最小的数据传输量。通过这样的协议设计，微信可以确保消息是稳定到达的，而且是按序到达。引用一句俗话：比它炫的没它简单，比它简单的没它快，没谁比他更快，哪怕在GPRS下，微信也能把进度条轻易推到底。

    1.2.1.1.5. 追求完美设计的团队不能胜任海量服务

      1.2.1.1.5.1. 在容灾之前面向最坏的思考，如果系统真的挂了，需要做一些事情，首先是防止雪崩，避免蝴蝶效应。如果关注春节订火车票就知道了，用户的请求量会因为系统服务不了而不断的重试，意味着发生雪崩的时候，系统可能会承载原先3-10倍的流量，使得所有的事情更加恶化。所以微信有很多“放雪”功能的设计。第二个词是柔性可用，在任何的系统中不要追求完美设计，追求完美设计的是团队是不能胜任海量服务的。如果在一个系统出现问题的时候，这个系统就挂了，那么这是一个不好的设计，最好的做法是提供0-1中间的选择。举一个例子，当一个用户向另外一个用户发消息的时候，可能会通过一个垃圾信息过滤的检测，如果垃圾信息过滤这个模块突然挂掉了，这个消息难道就不能达到了吗？在这样的情况下，要忽略掉这个错误，使得消息正常达到对方。要精确定位出哪一个环节是最为重要的，把不是重要的错误尽可能的忽略掉。当不能做到完美的时候，尽可能为用户提供服务。另外一个重要方面叫做“保护点前置”，最前的一个点就是终端，在手机终端上蕴埋更多的保护点，这样会为用户系统赢得更大的处理空间。如果终端具备这样的能力，会获得更大的反应空间。

1.2.2. 容灾

  1.2.2.1. 当系统出现了若干服务器或若干支架(宕机的时候)，仍然需要让系统尽可能的提供正常的服务。

    1.2.2.1.1. 在所有的容灾中存储层的容灾是最难的，一个系统的设计分为三层：接入层、逻辑层、存储层。接入层和逻辑层的容灾都有比较成熟的方案。逻辑层的容灾相对来说比较简单，尽量不要有状态的设计，比如说当你做上一个请求的时候，会保持一些状态，要使得下一个请求发到下一个服务器。如果任何一个请求之间互相不关联的话，这个就是无状态的设计，只要做到这一点逻辑层的容灾可以随意的切换。在回到存储层本身的容灾设计上，相对来说困难一些，但是微信研发团队采用了一些技巧，叫分而治之，分离业务场景，寻求简单的设计，并不会寻求大而同一的解决方案，因为这样会使得系统的复杂度大幅度上升，而微信会尽可能把产品拆细，寻求简化的设计。

    1.2.2.1.2. 首先是主备容灾，这是最常见的方案。在有一些业务场景中是可以容忍最终一致性的，比如账号系统的设计，每天写入账号系统的请求是非常少的，但是访问的请求非常多，这个差异可能会达到数万倍的规模，在这样的场景下，微信会在账号系统中采用简化的方案，也可以获得比较大的稳定度。

    1.2.2.1.3. 第二种容灾的模式叫双写，两台Master的机器，当一台机故障的时候，另外一台机还是可以接收到写请求，当两台机交错启动的时候，会得到数据的丢失。但是有一些场景是可以容忍轻度数据丢失的，比如说会有一个存储专门记录用户终端的类型，比如说安卓还是塞班以及他们使用终端的微信版本是什么，这样的数据是可以容忍轻度数据丢失的，因为偶尔有一些丢失的话，下一次访问会把这些数据带上来
，会尽快的修复所有的数据。双写也是非常简单的模式。

    1.2.2.1.4. 微信的研发团队做了一个叫Simple Quorum的机制，在微信的后台中，同步协议有一个很重要的基石叫序列发生器，这样的一个序列发生器需要有极高的稳定度。首先可以看到序列号有一个特点永远是递增的，用递增方式往前推进的时候，最大的序列号就是最新的系列号。有一个毕业才加入广研的毕业生想到一个绝佳的方案，按SET分布，从2G减到200K。

1.2.3. 轻重

  1.2.3.1. 如何在系统架构中分布功能，在哪一个点实现哪一个功能，代表系统中间的功能配置。

    1.2.3.1.1. 这个概念的提出主要是从终端本身的一些困境所带来的。首先在终端上需要表现最多的一个产品的逻辑，逻辑非常复杂，变更的成本也非常高，当需要修复的时候必须发布一个新版本，这个新版必须由自己下载才能完成，下载的成本非常高。在这样的前提下，如果手机终端产生了任何变化的时候，如果这个变化有非常大的问题就会有极大的困境，所以需要在每一个发布之前做一些充分的数据，确保不会发生致命问题。如果一旦出现致命问题难以修复，需要把关键的点从终端移到后台实现，把功能点后移，来充分发挥后台快速变更的能力。

    1.2.3.1.2. 在接入层的优化，速度很重要的因素，是不是能够就近接入一个最优的节点，比如说移动用户最好接入移动的节点，海外的用户可能需要寻找更佳的路由，有的时候可能无法自动做到这一点，一点是在终端上做测速，微信会通过在后台IP逆向的能力，通过后台指挥微信终端联网的能力，寻找最优的接入点。上图就是每分钟收到同一项指令曲线的报表。

    1.2.3.1.3. 如何解决“偷流量”的问题——当国内类微信类产品发布的时候出现一个大的问题就是“偷流量”，当用户在某一些逻辑下进行一个死循环，不断访问某一些数据，这样的死循环是非常可怕的，如果在用户不知觉的情况之下，可能会在一个小时之内偷到数10兆甚至数百兆的流量。有非常多业内的同行都需要花大量的精力解决这个问题，微信研发团队用了非常强大的方式解决它。通过在后台建立起严厉的监控
系统，对每一个用户的行为做一个监控，当发现异常的时候，后台会给终端发出指令，使得微信终端在一段时间无法联网，但是可以保证用户流量不会白白的使用掉。

    1.2.3.1.4. 功能适配的例子——第一期微信版本发布的时候，当时没有群聊的功能，第二版发布的时候做了这个功能。当时有两个选择，对于早期版本的用户，因为不支持群聊，就无法享用到这个功能，但是微信希望提供更好的选择，想让早期不支持群聊的版本，也可以被拉到一个群里面收消息、发消息，通过后台功能的适配也能做到这个事情。

1.2.4. 监控

  1.2.4.1. 为系统提供一个智能仪表盘

    1.2.4.1.1. 对于一个海量系统来说，一个精密的仪表盘非常重要。监控是非常痛苦的，对于这样一个系统来说，每小时会产生数百G的监控日志。微信希望在1分钟之内监控的数据就能够显示在报表上，因为只有这样的精准和实时度才能够赢得处理故障的时间。微信会做关联统计，通过摇一摇加了好友，他们活跃度如何，过了一段时间他们的活跃度变化情况又是如何。这种需求是需要通过大量日志的关联统计来获得的。研发团队也花了一段时间来理解这个问题，发现了中间一个重要的经验叫做“鱼和熊掌不能兼得”。

    1.2.4.1.2. 为了让监控数值更敏感，需要把监控细化再细化，上面数据表示每一栏子系统的数据，下面这个是按微信版本号来划分的，这里的数据项是非常多。

    1.2.4.1.3. 微信还需要采集一些异常的点，如果有异常的话会发布紧急的版本，尽可能快的替换它。对收发消息延时做的监控，比如说0—1秒端到端的速度，会对不同的区段做一些统计，当某一个环节出现异常的时候，通常会在中间的延时上体现出来。有一个很重要的点叫自动报警，现在有数千项的数据，不可能每一项都靠人工去看的，必须要跟自动报警相关联，微信有一些智能的算法，是不是在正常的范围内，跟历史的数值进行对比，如果有异常的话，会通过短信、邮件还有微信本身来发出报警信息。

    1.2.4.1.4. 把监控嵌入基础框架

      1.2.4.1.4.1. 微信会把监控嵌入到基础框架里面去，因为并不是每一个人都会意识到在需要的地方嵌入一个监控点，所以在基础框架本身内置很重要的监控点，比如说这个表上的栏目，非常多的栏目大概会有数百项的栏目，都不需要程序员自己去写，当用基础组件搭建一个系统的时候，就可以直接观测系统数据。

      1.2.4.1.4.2. 在谈到微信未来的技术挑战时，周颢首先希望能够让微信成为可用性99.99%的系统；设计出面向现在10倍容量的系统以及完全的IDC容灾。


-------------------------------------------------------------
1.3. 技术理念
-------------------------------------------------------------

1.3.1. 四大法器

  1.3.1.1. 大系统小做

    1.3.1.1.1. 当设计庞大系统的时候，应该尽量分割成更小的颗粒，使得项目之间的影响是最小的。

      1.3.1.1.1.1. 仅仅把模块变得更为清晰，这在海量系统设计开发中是不够的，还需要在物理环境上进行分离部署，出现问题的时候可以快速发现，并且在最快的情况下解决掉。

      1.3.1.1.1.2. 将不同的应用逻辑物理分割独立出来，用户注册登录、LBS逻辑、摇一摇逻辑、漂流瓶逻辑、消息逻辑独立开来。把关键的逻辑混搭在一起，当所有的逻辑部署在同一个服务器上，确
实也会带来很大敏捷上的好处，因为不需要额外的考虑部署和监控的问题。在整个微信的逻辑中，可能现在已经有上百种不同的逻辑，因为会在逻辑的分割上拆分成8-10种做分离部
署。

  1.3.1.2. 让一切可扩展

    1.3.1.2.1. 在高稳定度、高性能的系统中间，为了稳定性能把它设计成不变化的系统，但为了支持敏捷需要让一切的东西都要变得可以扩展。

      1.3.1.2.1.1. 网络协议可扩展、数据存储可扩展

      1.3.1.2.1.2. 扩展的关键点有两块。一个是网络协议需要扩展，当要升级一个新功能的时候，会有一些比较大的困难，所以所有协议设计都比较向前兼容，但是向前兼容还是不够的，因为网络协议设计本身有非常多的功能也会有比较大的字段，相关的代码可能会有数千行，这一块不能通过手写方式完成。可以通过XML描述，再通过工具自动生成所有的代码，这是微信获得快速开发的一个重要的点。

      1.3.1.2.1.3. 另外一块就是在数据存储方面是必须可扩展的。在2005年绝大多数海量系统的设计都是采用固定字段的存储，但是在现代系统中会意识到这个问题，会采用KV或者TLV的方式，微信也做了不同的设计。

  1.3.1.3. 要有基础组件

    1.3.1.3.1. 解决复杂问题的时候，需要将已有的经验固化下来，固化下来的东西会成为系统中的一部分

      1.3.1.3.1.1. 在微信后台会有几种不同的基础组件。大致包括：
      1.3.1.3.1.2. Svrkit——Client/Server自动代码生成框架:10分钟搭建内部服务器
      1.3.1.3.1.3. LogicServer——逻辑容器：随时添加新逻辑
      1.3.1.3.1.4. OssAgent——监控/统计框架：所见即所得的
监控报表

      1.3.1.3.1.5. 存储组件——屏蔽容灾/扩容等复杂问题

  1.3.1.4. 轻松上线

    1.3.1.4.1. 当做了变化并把它从开发环境中部署到现有的运营环境中去，在这个过程中，“灰度”这个词非常关键，就是在黑和白之间的选择，必须要变成一种小规模尝试，再逐步扩展到海量过程中的一个问题。

      1.3.1.4.1.1. 在变更后的部署方式上，微信在一些规则会限定不能一次把所有的逻辑变更上去，每一次变更一小点观察到每一个环节没有问题的时候，才能布局到全网上去。微信后台每一天可以支撑超过20个后台变更，在业界来说，通常做到5个已经是比较快了，但是微信可以做到快4倍。


-------------------------------------------------------------
1.4. 团队
-------------------------------------------------------------

1.4.1. 创业团队气氛

1.4.2. 弹性工作时间

1.4.3. 主要人物

  1.4.3.1. 张小龙

    1.4.3.1.1. 2005年3月，腾讯收购了国内知名电子邮件客户端Foxmail。Foxmail创始人张小龙及其研发团队20 余人在不久后进入腾讯。2005年4月腾讯广州研究院（后改称广州研发部，以下简称为“广研”）成立，主要负责邮件相关业务的研发和运营。经过三年打磨，QQ邮箱以其简洁易用、安全稳定的特点获得用户欢迎，并于2008年3月成为国内使用人数最多的邮箱产品。在这一过程中，广研团队经历了从做客户端产品到做web产品的艰难转型，在他们看来，“少即是多”的设计理念，对用户体验的极端重视，团队磨合和梯队建设，技术能力的积累和敏捷开发的经验，都是团队在QQ邮箱开发过程中的收获。

    1.4.3.1.2. 　　张小龙则经历了从程序员到产品经理、再到管理者的角色转换。在不断与邮箱用户互动的过程中，他对于产品和用户的理解不断加深。在不断提高QQ邮箱易用性和稳定性的基础上，他将邮箱平台作为产品理念的试验田，做出了阅读空间、QQ漂流瓶等产品。阅读空间提供了简单人际互动的功能，是他对“用户社区”和“社交类产品”的最初探索。漂流瓶为用户提供了全新的陌生人交友渠道和新奇有趣的体验，大幅提高了邮箱用户活跃度和用户粘性，这一产品形态后也被移植到微信中。

    1.4.3.1.3. 2011年中旬，广研分设“邮箱产品中心”和“微信产品中心”（见附录2广研组织架构图），开始独立运作QQ邮箱和微信两款产品。张小龙既是广研的总经理，也是微信产品团队的第一负责人。

  1.4.3.2. Lake：目前担任微信产品总监，统筹微信产品方面的工作。2005年3月加入广研，先后负
责QQmail、微信的产品团队。

  1.4.3.3. Lyle：目前担任微信iPhone终端开发组组长，主要负责iphone终端开发组的人员管理和项目管理工作。2010年10月加入广研。

  1.4.3.4. Harvey：目前担任广研助理总经理、微信中心负责人，统筹微信开发方面的工作。2005年9月加入广研，先后负责QQmail、微信的技术团队。

  1.4.3.5. Justin：目前担任微信终端开发组总监，主要负责微信终端开发组的人员管理和项目管理工
作。2004年7月进入腾讯，2005年10月加入广研。

  1.4.3.6. Genie：目前担任微信高级产品经理，负责微信产品策划、需求管理工作。2010年4月加入
广研。

  1.4.3.7. Ts：目前担任微信高级产品经理。负责微信产品策划、需求管理工作。2011年1月加入广研。

  1.4.3.8. Kink：目前担任微信客户端UI组组长，主要负责微信产品的交互、视觉方面的工作。2006
年9月加入广研。

  1.4.3.9. Juliet：目前担任微信营销拓展组组长，主要负责微信市场推广和品牌管理工作。2011年11月加入广研，其本人具有多年世界500强企业的营销经验


-------------------------------------------------------------
1.5. 成绩
-------------------------------------------------------------

1.5.1. 10个月

  1.5.1.1. 5000w用户

  1.5.1.2. 2000w活跃用户

  1.5.1.3. IOS、Android、Symbian

1.5.2. 一年内

  1.5.2.1. 44个版本

  1.5.2.2. 文字、语音、图片、视频


-------------------------------------------------------------
1.6. 大理念
-------------------------------------------------------------

1.6.1. 产品精准

1.6.2. 项目敏捷

1.6.3. 技术支撑

1.6.4. 在互联网开发里，如果能够有一个团队在更短的时间内尝试了更多机会(并能改进过来)，就能有(更多的)机会胜出

1.6.5. 容忍说哪怕在发布前的十分钟，也要允许他变更


